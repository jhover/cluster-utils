#!/usr/bin/env python
#
# qacct -j -d 1 -o hover
#  jobnum  jobname  wallclock  slots   maxvmem exit_status


import os
import pwd
import subprocess
import sys

def get_username():
    return pwd.getpwuid( os.getuid() )[ 0 ]

def get_history(days=1, user=get_username()):
    cmd = f"qacct -j -d  1 -o {user}"
    result = subprocess.check_output( cmd, shell=True, text=True )
    lines = result.split('\n')
    info = parse_output(lines)
    print(f"got {len(info)} jobs")
    return info

def parse_output(lines):
    lod = []
    current = None
    for line in lines:
        if line.startswith("======="):
            if current is not None:
                lod.append(current)
            current = {}
        else:
            key = line[0:13].strip()
            value = line[13:].strip()
            #print(f"{key} = {value}")
            if key == "jobnumber":
                current['jobnumber'] = value
            if key == "jobname":
                current['jobname'] = value
            
            elif key == "exit_status":
                current["exit_status"] = value
            if key == "slots":
                current['slots'] = value
            elif key == "wallclock":
                current["wallclock"] = value
            elif key == "maxvmem":
                current["maxvmem"] = value
    return lod    

def printjob(jobdict):
    fields = ["jobnumber", "jobname", "wallclock", "slots", "maxvmem", "exit_status"  ]
    s=""
    for f in fields:
       s += f" {jobdict[f]} " 
    #s += "\n"
    print(s)

if __name__ == '__main__':
    joblist = get_history()
    for job in joblist:
        printjob(job)
    

    
    